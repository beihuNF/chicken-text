<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æµ‹æµ‹ä½ æ˜¯ä»€ä¹ˆé¸¡</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ£</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FCD34D',
            primaryDark: '#F59E0B',
            secondary: '#FFFBEB',
            accent: '#EF4444',
            gold: '#FFD700',
            purple: '#A855F7',
            luck: '#10B981',
            achievement: '#3B82F6',
          },
          fontFamily: {
            sans: ['Arial Rounded MT Bold', 'Avenir', 'Helvetica', 'Arial', 'sans-serif'],
          },
          animation: {
            'bounce-slow': 'bounce 2s infinite',
            'wiggle': 'wiggle 1s ease-in-out infinite',
            'pulse-slow': 'pulse 3s infinite',
            'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
            'egg-shake': 'egg-shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
            'float-up': 'floatUp 10s linear infinite',
            'pulse-glow': 'pulseGlow 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'spin-rays': 'spin 10s linear infinite',
            'pop-in': 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
            'float': 'float 3s ease-in-out infinite',
          },
          keyframes: {
            wiggle: {
              '0%, 100%': { transform: 'rotate(-3deg)' },
              '50%': { transform: 'rotate(3deg)' },
            },
            shake: {
              '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
              '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
              '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
              '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
            },
            'egg-shake': {
              '0%': { transform: 'rotate(0deg)' },
              '25%': { transform: 'rotate(-5deg)' },
              '50%': { transform: 'rotate(5deg)' },
              '75%': { transform: 'rotate(-5deg)' },
              '100%': { transform: 'rotate(0deg)' }
            },
            floatUp: {
              '0%': { transform: 'translateY(100vh) rotate(0deg)', opacity: 0 },
              '10%': { opacity: 0.6 },
              '90%': { opacity: 0.6 },
              '100%': { transform: 'translateY(-20vh) rotate(360deg)', opacity: 0 }
            },
            pulseGlow: {
              '0%, 100%': { opacity: 0.5, transform: 'scale(1)' },
              '50%': { opacity: 0.8, transform: 'scale(1.1)' }
            },
            spin: {
              '0%': { transform: 'rotate(0deg)' },
              '100%': { transform: 'rotate(360deg)' }
            },
            popIn: {
              '0%': { opacity: 0, transform: 'scale(0.5)' },
              '100%': { opacity: 1, transform: 'scale(1)' }
            },
            float: {
              '0%, 100%': { transform: 'translateY(0px)' },
              '50%': { transform: 'translateY(-20px)' }
            }
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .text-shadow-lg { text-shadow: 0 4px 8px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08); }
    }
    
    :root {
      --color-primary: #FCD34D;
      --color-primary-dark: #F59E0B;
      --color-gold: #FFD700;
      --color-purple: #A855F7;
      --color-luck: #10B981;
      --animation-duration: 0.3s;
    }
    
    body {
      touch-action: none; 
      user-select: none; 
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden; 
    }

    .egg-svg {
      transition: transform 0.1s;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
      position: relative;
      z-index: 10;
    }
    .egg-body {
      transition: fill 0.5s ease, stroke 0.5s ease;
    }
    
    .egg-crack {
      fill: none;
      stroke: #D97706;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0;
      transition: opacity 0.2s, stroke 0.3s, filter 0.3s;
    }

    .crack-glow-gold {
      stroke: #FFD700 !important;
      filter: drop-shadow(0 0 2px #FFD700) drop-shadow(0 0 5px #F59E0B);
    }
    .crack-glow-purple {
      stroke: #A855F7 !important;
      filter: drop-shadow(0 0 2px #A855F7) drop-shadow(0 0 5px #9333EA);
    }

    .rays-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 300px;
      z-index: 0;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
    }
    
    .rays {
      width: 100%;
      height: 100%;
      background: conic-gradient(from 0deg, 
        transparent 0deg, var(--ray-color) 20deg, 
        transparent 40deg, var(--ray-color) 60deg, 
        transparent 80deg, var(--ray-color) 100deg, 
        transparent 120deg, var(--ray-color) 140deg, 
        transparent 160deg, var(--ray-color) 180deg, 
        transparent 200deg, var(--ray-color) 220deg, 
        transparent 240deg, var(--ray-color) 260deg, 
        transparent 280deg, var(--ray-color) 300deg, 
        transparent 320deg, var(--ray-color) 340deg, 
        transparent 360deg);
      animation: spin-rays 10s linear infinite;
      mask-image: radial-gradient(circle, transparent 30%, black 70%);
      -webkit-mask-image: radial-gradient(circle, transparent 30%, black 70%);
    }
    
    .charge-aura {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 180px;
      height: 220px;
      background: radial-gradient(circle, rgba(252, 211, 77, 0.6) 0%, rgba(252, 211, 77, 0) 70%);
      border-radius: 50%;
      z-index: 5;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .charging .charge-aura {
      opacity: 1;
      animation: pulseGlow 1s infinite alternate;
    }
    
    .fallback-emoji {
      font-size: 8rem;
      line-height: 1;
      width: 12rem;
      height: 12rem;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
    }

    .rare-bg {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fcd34d 100%);
      border-color: #fbbf24;
    }
    .special-bg {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #d8b4fe 100%);
      border-color: #c084fc;
    }

    .collection-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }
    .collection-item {
      aspect-ratio: 1;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem; 
      background-color: #F3F4F6;
      border: 2px solid #E5E7EB;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .collection-item.locked {
      filter: grayscale(100%);
      opacity: 0.6;
      cursor: default;
    }
    
    .collection-item.unlocked-normal {
      background-color: #FEF3C7;
      border-color: #FCD34D;
      box-shadow: 0 2px 4px rgba(252, 211, 77, 0.2);
    }

    @keyframes glow-gold {
      0%, 100% { border-color: #F59E0B; box-shadow: 0 0 5px #F59E0B, inset 0 0 5px rgba(245, 158, 11, 0.2); }
      50% { border-color: #FCD34D; box-shadow: 0 0 15px #FCD34D, inset 0 0 15px rgba(252, 211, 77, 0.5); }
    }
    @keyframes glow-purple {
      0%, 100% { border-color: #9333EA; box-shadow: 0 0 5px #9333EA, inset 0 0 5px rgba(147, 51, 234, 0.2); }
      50% { border-color: #C084FC; box-shadow: 0 0 15px #C084FC, inset 0 0 15px rgba(192, 132, 252, 0.5); }
    }

    .collection-item.unlocked-hidden {
      background: linear-gradient(135deg, #FEF9C3 0%, #FCD34D 100%);
      animation: glow-gold 2s infinite ease-in-out;
      border-width: 2px;
      z-index: 1;
    }

    .collection-item.unlocked-special {
      background: linear-gradient(135deg, #F3E8FF 0%, #D8B4FE 100%);
      animation: glow-purple 2s infinite ease-in-out;
      border-width: 2px;
      z-index: 1;
    }

    .collection-item.selected {
      transform: scale(1.05);
      border-width: 3px;
    }

    .floating-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    .float-item {
      position: absolute;
      bottom: -10%;
      opacity: 0;
      animation: floatUp 15s linear infinite;
    }

    .new-badge {
      position: absolute;
      top: -10px;
      left: -10px;
      background: #EF4444;
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      transform: rotate(-15deg);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 20;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .modal-enter { opacity: 0; transform: scale(0.95); }
    .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.3s, transform 0.3s; }
    .modal-exit { opacity: 1; transform: scale(1); }
    .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 0.3s, transform 0.3s; }
  </style>
</head>
<body class="bg-secondary min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">

  <div id="floating-bg" class="floating-bg"></div>

  <div id="preload-cache" style="position: absolute; width: 0; height: 0; overflow: hidden; opacity: 0; z-index: -1;"></div>

  <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white border-2 border-yellow-200 px-6 py-3 rounded-full shadow-xl z-[60] flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none">
    <span class="text-2xl animate-bounce">ğŸ¤</span>
    <span id="toast-message" class="text-gray-700 font-bold text-sm md:text-base whitespace-nowrap"></span>
  </div>

  <div class="absolute top-4 left-4 z-20 flex flex-col gap-2">
    <button id="btn-collection" class="bg-white p-2 rounded-full shadow-md text-xl hover:scale-110 transition-transform relative">
      ğŸ“–
      <span id="collection-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center hidden">!</span>
    </button>
    <button id="btn-achievement" class="bg-white p-2 rounded-full shadow-md text-xl hover:scale-110 transition-transform relative">
      ğŸ†
      <span id="achievement-badge" class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center hidden">!</span>
    </button>
    <button id="btn-stats" class="bg-white p-2 rounded-full shadow-md text-xl hover:scale-110 transition-transform">
      ğŸ“Š
    </button>
  </div>
  <div class="absolute top-4 right-4 z-20 flex flex-col gap-2">
    <button id="btn-mute" class="bg-white p-2 rounded-full shadow-md text-xl hover:scale-110 transition-transform">
      ğŸ”Š
    </button>
  </div>
  
  <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-20">
    <div class="bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-md flex items-center gap-2">
      <span class="text-sm font-bold text-gray-700">ğŸ€ å¹¸è¿å€¼:</span>
      <span id="luck-value" class="text-sm font-bold text-luck">50</span>
      <div class="w-20 bg-gray-200 rounded-full h-2">
        <div id="luck-bar" class="bg-luck h-2 rounded-full transition-all duration-300" style="width: 50%"></div>
      </div>
    </div>
  </div>

  <div class="container max-w-md mx-auto text-center z-10">
    <h1 class="text-4xl md:text-5xl font-bold mb-6 text-primaryDark text-shadow-lg select-none">
      æµ‹æµ‹ä½ æ˜¯ä»€ä¹ˆé¸¡ <span class="text-accent">ğŸ£</span>
    </h1>
    
    <div id="main-card" class="bg-white rounded-3xl shadow-lg p-6 mb-8 transform transition-all duration-300 hover:shadow-xl border-4 border-yellow-100 relative overflow-hidden">
      
      <div id="test-area" class="mb-2">
        <div class="progress-container mx-auto cursor-pointer active:scale-95 transition-transform duration-100 relative w-[200px] h-[200px] flex items-center justify-center">
          
          <div id="egg-rays" class="rays-container">
            <div class="rays"></div>
          </div>

          <div class="charge-aura"></div>

          <svg class="egg-svg w-full h-full" viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
            <path id="egg-body" class="egg-body" d="M100 10 C 50 10, 10 90, 10 150 C 10 210, 50 240, 100 240 C 150 240, 190 210, 190 150 C 190 90, 150 10, 100 10 Z" fill="#FEF3C7" stroke="#F59E0B" stroke-width="3"/>
            <path id="crack-1" class="egg-crack" d="M100 10 L 90 40 L 110 60" />
            <path id="crack-2" class="egg-crack" d="M100 10 L 90 40 L 110 60 L 80 90 L 100 120" />
            <path id="crack-3" class="egg-crack" d="M100 10 L 90 40 L 110 60 L 80 90 L 100 120 L 120 150 L 90 180" />
          </svg>
          
          <div id="press-hint" class="press-hint absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none">
            <div class="text-5xl mb-2 animate-bounce">ğŸ¥š</div>
            <p class="text-lg text-gray-500 font-medium whitespace-nowrap">é•¿æŒ‰å­µåŒ–</p>
          </div>
        </div>
        
        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-6 mb-2 overflow-hidden">
          <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        
        <p id="instruction" class="text-gray-500 font-medium h-6 transition-opacity duration-300">
          å‡†å¤‡å¥½è¿æ¥ä½ çš„é¸¡äº†å—ï¼Ÿ
        </p>
      </div>
      
      <div id="result-area" class="hidden w-full">
        <div id="capture-target" class="p-4 bg-white rounded-3xl w-full mx-auto shadow-sm relative">
          <div id="new-badge-container"></div>
          
          <div id="result-card-inner" class="bg-yellow-50 rounded-2xl p-6 flex flex-col items-center justify-center min-h-[20rem] border-4 border-yellow-100 transition-colors duration-500 relative w-full">
            
            <div id="rare-tag" class="hidden absolute top-3 right-3 px-3 py-1 text-white text-xs font-bold rounded-full shadow-sm z-10">
            </div>

            <div id="result-visual" class="mb-4 relative z-0">
              <img id="result-image" class="w-40 h-40 md:w-48 md:h-48 object-contain hidden filter drop-shadow-md animate-float" src="" alt="ç»“æœå›¾ç‰‡" crossorigin="anonymous">
              <div id="result-emoji-display" class="fallback-emoji hidden flex items-center justify-center animate-float"></div>
            </div>
            
            <h2 id="result-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-2"></h2>
            <p id="result-description" class="text-gray-600 text-base md:text-lg px-2 leading-relaxed">
              
            </p>
            
            <div class="mt-4 pt-3 border-t border-black/5 w-full">
              <p id="random-quote" class="text-xs text-gray-400 italic font-medium"></p>
            </div>
            
            <p class="text-[10px] text-gray-300 mt-2">æµ‹æµ‹ä½ æ˜¯ä»€ä¹ˆé¸¡</p>
          </div>
        </div>
        
        <div class="flex flex-col gap-3 mt-6">
          <div class="flex gap-3 justify-center">
            <button id="btn-share" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-2xl font-bold shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2 text-sm md:text-base">
              ğŸ“¸ ç”Ÿæˆæµ·æŠ¥
            </button>
            <button id="btn-copy" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-2xl font-bold shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2 text-sm md:text-base">
              ğŸ”— å¤åˆ¶ç»“æœ
            </button>
          </div>
          <button id="retest-button" class="w-full bg-primary hover:bg-primaryDark text-white text-lg py-3.5 rounded-2xl font-bold shadow-md transition-all transform hover:-translate-y-1 active:translate-y-0 active:scale-95">
            å†å­µä¸€æ¬¡ ğŸ¥š
          </button>
        </div>
        
        <p class="text-gray-400 text-xs mt-4">
          æç¤ºï¼šç»“æœå·²è‡ªåŠ¨æ”¶å½•åˆ°å›¾é‰´ä¸­
        </p>
      </div>
    </div>
    
    <footer class="text-gray-400 text-sm pb-8 w-full flex flex-col items-center gap-4">
      <div class="flex flex-col items-center justify-center gap-3">
        
        <a href="https://github.com/beihuNF" target="_blank" class="inline-flex items-center gap-2 bg-yellow-50 text-yellow-700 hover:text-yellow-800 hover:bg-yellow-100 px-4 py-1.5 rounded-full border border-yellow-200 shadow-sm select-none transition-all active:scale-95 no-underline">
          <span class="text-xs font-bold text-yellow-500 uppercase tracking-wider">ä½œè€…</span>
          <span class="font-bold">beihuNF</span>
        </a>

        <a href="https://qm.qq.com/q/ALM4b3lzCo" target="_blank" class="inline-flex items-center gap-2 bg-blue-50 text-blue-600 hover:text-blue-700 hover:bg-blue-100 px-4 py-1.5 rounded-full border border-blue-200 transition-all active:scale-95 no-underline shadow-sm group">
          <span class="text-xs font-bold text-blue-400 group-hover:text-blue-500 uppercase tracking-wider">QQäº¤æµç¾¤</span>
          <span class="font-medium font-mono text-sm pt-0.5">1169960292</span>
        </a>

      </div>

      <div class="text-xs text-gray-400 mt-2 flex items-center gap-1">
        <span>ğŸ¥š çµæ„Ÿå­µåŒ–è‡ªéš”å£çŒªåœˆï¼š</span>
        <a href="https://nanancc.github.io/pig-text/?darkmode=0" target="_blank" class="font-bold text-yellow-500 hover:text-yellow-600 underline decoration-dashed underline-offset-4 transition-colors">
          æµ‹æµ‹ä½ æ˜¯ä¸æ˜¯çŒª
        </a>
      </div>
    </footer>
  </div>

  <div id="collection-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="bg-white rounded-3xl w-11/12 max-w-md p-6 max-h-[90vh] flex flex-col shadow-2xl relative transform transition-all scale-95 opacity-0" id="collection-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">ğŸ” é¸¡çªå›¾é‰´</h2>
        <button id="btn-close-collection" class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">Ã—</button>
      </div>
      
      <div class="overflow-y-auto flex-1 p-1">
        <div class="collection-grid mb-4" id="collection-grid">
        </div>
        
        <div id="collection-detail-panel" class="bg-gray-50 rounded-xl p-4 hidden border border-gray-100 shadow-inner">
          <div class="flex flex-col items-center text-center">
             <div class="mb-2">
                <img id="detail-img" class="w-24 h-24 object-contain hidden" src="">
                <div id="detail-emoji" class="text-6xl hidden"></div>
             </div>
             <h3 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
               <span id="detail-name"></span>
               <span id="detail-tag" class="hidden text-xs px-2 py-0.5 rounded-full text-white"></span>
             </h3>
             <p id="detail-desc" class="text-sm text-gray-600 leading-relaxed"></p>
          </div>
        </div>
      </div>

      <div class="mt-4 text-center text-sm text-gray-500 border-t pt-4 flex flex-col gap-1">
        <div>æ”¶é›†è¿›åº¦: <span id="collection-count" class="font-bold text-primaryDark">0</span> / <span id="total-count">0</span></div>
        <div class="text-xs text-gray-400">å·²ç´¯è®¡å­µåŒ– <span id="total-draws" class="font-bold text-blue-500">0</span> æ¬¡</div>
      </div>
    </div>
  </div>

  <div id="achievement-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="bg-white rounded-3xl w-11/12 max-w-md p-6 max-h-[90vh] flex flex-col shadow-2xl relative transform transition-all scale-95 opacity-0" id="achievement-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">ğŸ† æˆå°±æ®¿å ‚</h2>
        <button id="btn-close-achievement" class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">Ã—</button>
      </div>
      
      <div class="overflow-y-auto flex-1 p-1">
        <div id="achievement-list" class="space-y-3">
        </div>
      </div>

      <div class="mt-4 text-center text-sm text-gray-500 border-t pt-4">
        å·²è§£é”æˆå°±: <span id="achievement-count" class="font-bold text-achievement">0</span> / <span id="achievement-total">0</span>
      </div>
    </div>
  </div>

  <div id="stats-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="bg-white rounded-3xl w-11/12 max-w-md p-6 max-h-[90vh] flex flex-col shadow-2xl relative transform transition-all scale-95 opacity-0" id="stats-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
        <button id="btn-close-stats" class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">Ã—</button>
      </div>
      
      <div class="overflow-y-auto flex-1 p-1">
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 mb-4">
          <h3 class="font-bold text-gray-700 mb-3">ğŸ“Š æ€»ä½“æ•°æ®</h3>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-white rounded-lg p-3">
              <div class="text-2xl font-bold text-primary" id="stats-total-draws">0</div>
              <div class="text-xs text-gray-500">æ€»å­µåŒ–æ¬¡æ•°</div>
            </div>
            <div class="bg-white rounded-lg p-3">
              <div class="text-2xl font-bold text-purple" id="stats-collection">0/0</div>
              <div class="text-xs text-gray-500">æ”¶é›†è¿›åº¦</div>
            </div>
            <div class="bg-white rounded-lg p-3">
              <div class="text-2xl font-bold text-luck" id="stats-luck">50</div>
              <div class="text-xs text-gray-500">å½“å‰å¹¸è¿å€¼</div>
            </div>
            <div class="bg-white rounded-lg p-3">
              <div class="text-2xl font-bold text-achievement" id="stats-achievements">0</div>
              <div class="text-xs text-gray-500">å·²è§£é”æˆå°±</div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 mb-4">
          <h3 class="font-bold text-gray-700 mb-3">ğŸŒŸ ç¨€æœ‰åº¦ç»Ÿè®¡</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">æ™®é€šæ¬¾</span>
              <span class="font-bold text-gray-700" id="stats-normal">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">ç‰¹æ®Šæ¬¾</span>
              <span class="font-bold text-purple" id="stats-special">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">éšè—æ¬¾</span>
              <span class="font-bold text-gold" id="stats-hidden">0</span>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 rounded-xl p-4">
          <h3 class="font-bold text-gray-700 mb-3">ğŸ“œ æœ€è¿‘å­µåŒ–</h3>
          <div id="history-list" class="space-y-2 max-h-40 overflow-y-auto">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      BASE_WEIGHTS: {
        NORMAL: 47,
        SPECIAL: 50,
        HIDDEN: 25
      },
      LUCK_MULTIPLIER: {
        SPECIAL: 1.5,
        HIDDEN: 0.8
      },
      HATCHING_DURATION: 2500,
      INITIAL_LUCK: 50,
      DAILY_LUCK_BONUS: 5,
      MAX_LUCK: 100,
      HISTORY_MAX_LENGTH: 20
    };
    
    const tips = [
      "å¬è¯´é•¿æŒ‰çš„æ—¶é—´è¶Šä¹…ï¼Œå­µå‡ºçš„é¸¡è¶Šç¨€æœ‰ï¼Ÿï¼ˆå‡çš„ï¼‰",
      "æ¯åªé¸¡éƒ½æœ‰è‡ªå·±çš„æ€§æ ¼ï¼Œå°±åƒä½ ä¸€æ ·ã€‚",
      "å­µåŒ–éœ€è¦è€å¿ƒï¼Œæ­£å¦‚ç”Ÿæ´»éœ€è¦ç­‰å¾…ã€‚",
      "è¯•è¯•åœ¨æ·±å¤œå­µåŒ–ï¼Œè¯´ä¸å®šä¼šæœ‰å¥‡è¿¹ï¼Ÿ",
      "ä¸è¦æ™ƒåŠ¨æ‰‹æœºï¼Œå°å¿ƒè›‹é»„æ•£äº†ï¼",
      "é›†é½æ‰€æœ‰å›¾é‰´å¯ä»¥å¬å”¤...ä»€ä¹ˆä¹Ÿæ²¡æœ‰ã€‚",
      "æ®è¯´å¬ç€éŸ³ä¹å­µåŒ–ï¼Œé¸¡çš„è‰ºæœ¯ç»†èƒä¼šå¢åŠ ã€‚",
      "æ‰‹æŒ‡ä¸è¦æŠ–ï¼Œå°é¸¡åœ¨çœ‹ç€ä½ å‘¢ã€‚",
      "æƒ³è¦éšè—æ¬¾ï¼Ÿè¯•è¯•å¤§å–Šä¸€å£°â€œèŠéº»å¼€é—¨â€ï¼",
      "æ®è¯´åªæœ‰ 1% çš„äººèƒ½æŠ½åˆ°é‚£åªä¼ è¯´ä¸­çš„é¸¡ã€‚",
      "å­µåŒ–ä¸­... æ­£åœ¨æ³¨å…¥çµé­‚...",
      "ä»Šå¤©çš„è¿æ°”æ€ä¹ˆæ ·ï¼Ÿè®©è¿™é¢—è›‹å‘Šè¯‰ä½ ã€‚",
      "ä¿æŒå‘¼å¸å¹³ç¨³ï¼Œæœ‰åŠ©äºå­µåŒ–æˆåŠŸã€‚",
      "å¦‚æœä¸å°å¿ƒå­µå‡ºäº†æ€ªä¸œè¥¿ï¼Œè¯·ä¸è¦æƒŠæ…Œã€‚"
    ];

    const chickenQuotes = [
      "å¤§å‰å¤§åˆ©ï¼Œä»Šæ™šåƒé¸¡ï¼",
      "ä¸è¦åšå’¸é±¼ï¼Œè¦åšä¸€åªå¥‹æ–—çš„é¸¡ã€‚",
      "åœ¨è¿™ä¸ªçœ‹è„¸çš„ä¸–ç•Œï¼Œä½ é€‰æ‹©äº†çœ‹é¸¡ã€‚",
      "åªæœ‰æ‹¼å‡ºæ¥çš„ç¾ä¸½ï¼Œæ²¡æœ‰ç­‰å‡ºæ¥çš„è¾‰ç…Œã€‚ â€”â€” æˆ˜æ–—é¸¡",
      "ç”Ÿæ´»å°±åƒè¿™é¢—è›‹ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä¸‹ä¸€åªä¼šæ˜¯ä»€ä¹ˆã€‚",
      "æœ‰æ—¶å€™ï¼Œé€€ä¸€æ­¥æµ·é˜”å¤©ç©ºï¼Œè¿›ä¸€æ­¥...å°±æ˜¯ç‚¸é¸¡åº—ã€‚",
      "å°±ç®—æ˜¯å°é»„é¸¡ï¼Œä¹Ÿæœ‰å¤§å¤§çš„æ¢¦æƒ³ã€‚",
      "ä¸å…¶åœ¨åˆ«äººçš„ç”Ÿæ´»é‡Œè·‘é¾™å¥—ï¼Œä¸å¦‚åšè‡ªå·±æ•…äº‹é‡Œçš„ä¸»è§’é¸¡ã€‚",
      "å³ä½¿æ˜¯è½æ±¤é¸¡ï¼ŒæŠ–æŠ–æ°´ï¼Œä¾ç„¶æ˜¯ä¸€æ¡å¥½æ±‰ã€‚",
      "æ—©èµ·çš„é¸Ÿå„¿æœ‰è™«åƒï¼Œæ—©èµ·çš„é¸¡å„¿è¢«äººåƒã€‚",
      "æ‰€æœ‰çš„è¿æ°”ï¼Œéƒ½è—åœ¨ä½ çš„åšæŒé‡Œã€‚",
      "å’¯å’¯å“’~ å’¯å’¯å“’~ (è¿™å¥æœ€æœ‰å“²ç†)",
      "ä¸ç®¡æ˜¯ç™½é¸¡é»‘é¸¡ï¼Œèƒ½å¸¦æ¥å¿«ä¹çš„å°±æ˜¯å¥½é¸¡ã€‚"
    ];

    const ACHIEVEMENTS = [
      { id: 'first-hatch', name: 'åˆå‡ºèŒ…åº', desc: 'å®Œæˆç¬¬ä¸€æ¬¡å­µåŒ–', emoji: 'ğŸ£', condition: () => state.drawCount >= 1 },
      { id: 'draw-10', name: 'æ–°æ‰‹é¥²å…»å‘˜', desc: 'ç´¯è®¡å­µåŒ–10æ¬¡', emoji: 'ğŸŒ±', condition: () => state.drawCount >= 10 },
      { id: 'draw-50', name: 'èµ„æ·±é¥²å…»å‘˜', desc: 'ç´¯è®¡å­µåŒ–50æ¬¡', emoji: 'â­', condition: () => state.drawCount >= 50 },
      { id: 'draw-100', name: 'å­µåŒ–å¤§å¸ˆ', desc: 'ç´¯è®¡å­µåŒ–100æ¬¡', emoji: 'ğŸ”¥', condition: () => state.drawCount >= 100 },
      { id: 'collect-5', name: 'åˆçº§æ”¶è—å®¶', desc: 'æ”¶é›†5åªä¸åŒçš„é¸¡', emoji: 'ğŸ“–', condition: () => state.unlockedIds.size >= 5 },
      { id: 'collect-10', name: 'ä¸­çº§æ”¶è—å®¶', desc: 'æ”¶é›†10åªä¸åŒçš„é¸¡', emoji: 'ğŸ“š', condition: () => state.unlockedIds.size >= 10 },
      { id: 'collect-all', name: 'å›¾é‰´å®Œæˆ', desc: 'æ”¶é›†å…¨éƒ¨é¸¡', emoji: 'ğŸ‘‘', condition: () => state.unlockedIds.size >= chickenResults.length },
      { id: 'first-hidden', name: 'éšè—æ¢ç´¢è€…', desc: 'è·å¾—ç¬¬ä¸€åªéšè—æ¬¾', emoji: 'âœ¨', condition: () => [...state.unlockedIds].some(id => chickenResults.find(c => c.id === id)?.category === 'hidden') },
      { id: 'first-special', name: 'ç‰¹æ®Šé‚‚é€…', desc: 'è·å¾—ç¬¬ä¸€åªç‰¹æ®Šæ¬¾', emoji: 'ğŸŒŸ', condition: () => [...state.unlockedIds].some(id => chickenResults.find(c => c.id === id)?.category === 'special') },
      { id: 'lucky-streak', name: 'å¹¸è¿è¿å‡»', desc: 'å¹¸è¿å€¼è¾¾åˆ°100', emoji: 'ğŸ€', condition: () => state.luckValue >= 100 }
    ];

    const BASE_WEIGHTS = {
      NORMAL: 47,
      SPECIAL: 50,
      HIDDEN: 25
    };

    const chickenResults = [
      { id: "normal-chicken", name: "æ™®é€šé¸¡", emoji: "ğŸ”", description: "å°±æ˜¯ä¸€åªæ™®æ™®é€šé€šçš„å®¶å…»é¸¡ï¼Œç”Ÿæ´»ä¹æ— è¾¹ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "fighter-chicken", name: "æˆ˜æ–—é¸¡", emoji: "ğŸ¥Š", description: "å…¬é¸¡ä¸­çš„æˆ˜æ–—æœºï¼å™¢è€¶ï¼", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "fried-chicken", name: "è‚¯å¾·é¸¡", emoji: "ğŸ—", description: "é¦™å–·å–·ï¼Œé…¥è„†è„†ï¼Œå¤§å®¶éƒ½çˆ±ä½ ï¼ˆçš„è‚‰ä½“ï¼‰ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "screaming-chicken", name: "å°–å«é¸¡", emoji: "ğŸ˜±", description: "è™½ç„¶å¾ˆåµï¼Œä½†æ˜¯èƒ½ç»™åˆ«äººå¸¦æ¥å¿«ä¹ï¼ˆæˆ–ç—›è‹¦ï¼‰ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "weak-chicken", name: "å¼±é¸¡", emoji: "ğŸƒ", description: "èº«ä½“è™½ç„¶å­±å¼±ï¼Œä½†å¤´è„‘...å¯èƒ½ä¹Ÿä¸å¤ªè¡Œã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "drowned-chicken", name: "è½æ±¤é¸¡", emoji: "ğŸ’¦", description: "æœ€è¿‘æ°´é€†ï¼Œå‡ºé—¨è®°å¾—å¸¦ä¼ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "iron-rooster", name: "é“å…¬é¸¡", emoji: "ğŸª™", description: "ä¸€æ¯›ä¸æ‹”ï¼å‹¤ä¿­æŒå®¶çš„æè‡´ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "mahjong-chicken", name: "å¹ºé¸¡", emoji: "ğŸ€", description: "éº»å°†æ¡Œä¸Šçš„å¸¸å®¢ï¼Œå®¹æ˜“è¢«æ ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "spicy-chicken", name: "è¾£å­é¸¡", emoji: "ğŸŒ¶ï¸", description: "æ€§æ ¼ç«è¾£ï¼Œè®©äººæ¬²ç½¢ä¸èƒ½ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "repeater-chicken", name: "å¤è¯»é¸¡", emoji: "ğŸ”", description: "äººç±»çš„æœ¬è´¨æ˜¯å¤è¯»æœºï¼Œé¸¡ä¹Ÿä¸€æ ·ã€‚é¸¡ä¹Ÿä¸€æ ·ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "kung-pao-chicken", name: "å®«ä¿é¸¡ä¸", emoji: "ğŸ¥œ", description: "ä½ çš„çµé­‚é‡Œå……æ»¡äº†èŠ±ç”Ÿç±³çš„é¦™æ°”ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "crane-chicken", name: "é¹¤ç«‹é¸¡ç¾¤", emoji: "ğŸ¦¢", description: "ç”±äºå¤ªè¿‡ä¼˜ç§€ï¼Œåœ¨é¸¡ç¾¤ä¸­æ˜¾å¾—æ ¼æ ¼ä¸å…¥ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "wooden-chicken", name: "å‘†è‹¥æœ¨é¸¡", emoji: "ğŸªµ", description: "æ³°å±±å´©äºå‰è€Œè‰²ä¸å˜ï¼Œå…¶å®æ˜¯ååº”æ…¢ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "little-chick", name: "å°é»„é¸¡", emoji: "ğŸ¥", description: "æ°¸è¿œé•¿ä¸å¤§çš„å®å®ï¼Œå¯å¯çˆ±çˆ±ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "old-hen", name: "è€æ¯é¸¡", emoji: "ğŸ²", description: "æˆç†Ÿç¨³é‡ï¼Œé€‚åˆç‚–æ±¤ï¼ˆåˆ’æ‰ï¼‰ç…§é¡¾äººã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "call-chicken", name: "æ‰“é¸£é¸¡", emoji: "â°", description: "å¤©ç”Ÿé—¹é’Ÿï¼Œæ—©èµ·è¾¾äººï¼Œé‚»å±…çš„æœ€çˆ±ã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "gym-chicken", name: "è‚Œéœ¸é¸¡", emoji: "ğŸ’ª", description: "ç”šè‡³ä¸åƒè›‹ç™½ç²‰å°±èƒ½ç»ƒå‡ºèƒ¸è‚Œã€‚", baseWeight: BASE_WEIGHTS.NORMAL },
      { id: "nugget", name: "éº¦ä¹é¸¡", emoji: "ğŸ¥¡", description: "è™½ç„¶æ˜¯åˆæˆçš„ï¼Œä½†ä¹Ÿè¦æ´»å¾—ç²¾å½©ï¼", baseWeight: BASE_WEIGHTS.NORMAL },
      
      { id: "phoenix", name: "å‡¤å‡°", emoji: "ğŸ”¥", description: "å…¶å®ä½ æ˜¯å‡¤å‡°ï¼Œåªæ˜¯æš‚æ—¶åœ¨é¸¡çªé‡Œå§åº•ã€‚", category: "hidden", baseWeight: BASE_WEIGHTS.HIDDEN },
      { id: "strange-chicken", name: "åªå› ", emoji: "ğŸ€", description: "ä½ ä¼šå”±ã€è·³ã€Rapå’Œç¯®çƒå—ï¼Ÿ", category: "hidden", baseWeight: BASE_WEIGHTS.HIDDEN },
      
      { id: "human", name: "äººç±»", emoji: "ğŸ§‘", description: "ç»è¿‡ç²¾å¯†æ£€æµ‹ï¼Œä½ ç«Ÿç„¶æ˜¯ä¸ªäººç±»ï¼æ˜¯ä¸æ˜¯èµ°é”™ç‰‡åœºäº†ï¼Ÿ", category: "special", baseWeight: BASE_WEIGHTS.SPECIAL },
      { id: "renji", name: "ä»æµ", emoji: "ğŸ¤–", description: "è™½ç„¶åå­—å¥½å¬ï¼Œä½†å…¶å®æ˜¯â€˜äººæœºâ€™çš„æ„æ€ã€‚ä½ åƒäººæœºä¸€æ ·å‘†å‘†çš„ï¼Œçœ¼ç¥ä¸­é€ç€æ¸…æ¾ˆçš„æ„šè ¢ã€‚", category: "special", baseWeight: BASE_WEIGHTS.SPECIAL }
    ];

    const state = {
      isMuted: localStorage.getItem('isMuted') === 'true',
      isHolding: false,
      startTime: 0,
      progressInterval: null,
      unlockedIds: new Set(JSON.parse(localStorage.getItem('unlockedChickens') || '[]')),
      drawCount: parseInt(localStorage.getItem('drawCount') || '0'),
      hasCelebratedFullCollection: false,
      pendingResult: null,
      luckValue: parseInt(localStorage.getItem('luckValue') || CONFIG.INITIAL_LUCK),
      unlockedAchievements: new Set(JSON.parse(localStorage.getItem('unlockedAchievements') || '[]')),
      history: JSON.parse(localStorage.getItem('history') || '[]')
    };

    const dom = {
      testArea: document.getElementById('test-area'),
      resultArea: document.getElementById('result-area'),
      resultCardInner: document.getElementById('result-card-inner'),
      progressBar: document.getElementById('progress-bar'),
      pressHint: document.getElementById('press-hint'),
      instruction: document.getElementById('instruction'),
      resultImage: document.getElementById('result-image'),
      resultEmojiDisplay: document.getElementById('result-emoji-display'),
      resultTitle: document.getElementById('result-title'),
      resultDescription: document.getElementById('result-description'),
      randomQuote: document.getElementById('random-quote'),
      rareTag: document.getElementById('rare-tag'),
      newBadgeContainer: document.getElementById('new-badge-container'),
      btnCollection: document.getElementById('btn-collection'),
      collectionBadge: document.getElementById('collection-badge'),
      btnMute: document.getElementById('btn-mute'),
      btnShare: document.getElementById('btn-share'),
      btnCopy: document.getElementById('btn-copy'),
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toast-message'),
      collectionModal: document.getElementById('collection-modal'),
      collectionContent: document.getElementById('collection-content'),
      btnCloseCollection: document.getElementById('btn-close-collection'),
      collectionGrid: document.getElementById('collection-grid'),
      collectionCount: document.getElementById('collection-count'),
      totalCount: document.getElementById('total-count'),
      totalDraws: document.getElementById('total-draws'),
      collectionDetailPanel: document.getElementById('collection-detail-panel'),
      detailImg: document.getElementById('detail-img'),
      detailEmoji: document.getElementById('detail-emoji'),
      detailName: document.getElementById('detail-name'),
      detailTag: document.getElementById('detail-tag'),
      detailDesc: document.getElementById('detail-desc'),
      eggSvg: document.querySelector('.egg-svg'),
      eggBody: document.getElementById('egg-body'),
      eggRays: document.getElementById('egg-rays'),
      eggRaysInner: document.querySelector('.rays'),
      cracks: [document.getElementById('crack-1'), document.getElementById('crack-2'), document.getElementById('crack-3')],
      floatingBg: document.getElementById('floating-bg'),
      luckValue: document.getElementById('luck-value'),
      luckBar: document.getElementById('luck-bar'),
      btnAchievement: document.getElementById('btn-achievement'),
      achievementBadge: document.getElementById('achievement-badge'),
      btnStats: document.getElementById('btn-stats'),
      achievementModal: document.getElementById('achievement-modal'),
      achievementContent: document.getElementById('achievement-content'),
      btnCloseAchievement: document.getElementById('btn-close-achievement'),
      achievementList: document.getElementById('achievement-list'),
      achievementCount: document.getElementById('achievement-count'),
      achievementTotal: document.getElementById('achievement-total'),
      statsModal: document.getElementById('stats-modal'),
      statsContent: document.getElementById('stats-content'),
      btnCloseStats: document.getElementById('btn-close-stats'),
      statsTotalDraws: document.getElementById('stats-total-draws'),
      statsCollection: document.getElementById('stats-collection'),
      statsLuck: document.getElementById('stats-luck'),
      statsAchievements: document.getElementById('stats-achievements'),
      statsNormal: document.getElementById('stats-normal'),
      statsSpecial: document.getElementById('stats-special'),
      statsHidden: document.getElementById('stats-hidden'),
      historyList: document.getElementById('history-list')
    };

    const init = () => {
      preloadImages();
      updateCollectionStats();
      updateLuckDisplay();
      showRandomTip();
      initFloatingBg();
      
      dom.btnMute.textContent = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      dom.achievementTotal.textContent = ACHIEVEMENTS.length;
      
      const lastResult = localStorage.getItem('currentResult');
      if (lastResult) {
        showResult(JSON.parse(lastResult), false, false);
      }
    };

    const preloadImages = () => {
      const cacheContainer = document.getElementById('preload-cache');
      chickenResults.forEach(chicken => {
        const img = new Image();
        img.src = `image/${chicken.id}.png`;
        img.style.display = 'none';
        if (cacheContainer) {
            cacheContainer.appendChild(img);
        }
      });
    };

    const initFloatingBg = () => {
      const emojis = ['ğŸ¥š', 'ğŸ£', 'ğŸ¥', 'ğŸ“', 'ğŸ¾', 'ğŸŒ¾'];
      const container = dom.floatingBg;
      
      for (let i = 0; i < 15; i++) {
        const el = document.createElement('div');
        el.className = 'float-item text-2xl absolute opacity-0 select-none';
        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        el.style.left = `${Math.random() * 100}%`;
        el.style.animationDelay = `${Math.random() * 10}s`;
        el.style.animationDuration = `${10 + Math.random() * 10}s`; 
        el.style.fontSize = `${1 + Math.random()}rem`;
        container.appendChild(el);
      }
    };

    let toastTimeout;
    const showToast = (message) => {
      if (toastTimeout) clearTimeout(toastTimeout);
      dom.toastMessage.textContent = message;
      dom.toast.classList.remove('opacity-0', 'translate-y-[-20px]');
      dom.toast.classList.add('opacity-100', 'translate-y-0');
      toastTimeout = setTimeout(() => {
        dom.toast.classList.remove('opacity-100', 'translate-y-0');
        dom.toast.classList.add('opacity-0', 'translate-y-[-20px]');
      }, 3000);
    };

    const showRandomTip = () => {
      const randomIndex = Math.floor(Math.random() * tips.length);
      dom.instruction.textContent = tips[randomIndex];
    };

    const generateWeightedResult = () => {
      const luckMultiplier = state.luckValue / 100;
      
      let totalWeight = 0;
      const currentWeights = chickenResults.map(chicken => {
        let weight = chicken.baseWeight;
        if (chicken.category === 'special') {
            weight += state.drawCount * CONFIG.LUCK_MULTIPLIER.SPECIAL * luckMultiplier;
        } else if (chicken.category === 'hidden') {
            weight += state.drawCount * CONFIG.LUCK_MULTIPLIER.HIDDEN * luckMultiplier;
        }
        totalWeight += weight;
        return { ...chicken, finalWeight: weight };
      });

      let random = Math.random() * totalWeight;
      
      for (const chicken of currentWeights) {
        if (random < chicken.finalWeight) {
          return chicken;
        }
        random -= chicken.finalWeight;
      }
      return chickenResults[0];
    };

    const finishHatching = (result) => { 
      playSound('crack');
      dom.testArea.classList.add('hidden');
      dom.resultArea.classList.remove('hidden');
      
      state.drawCount++;
      localStorage.setItem('drawCount', state.drawCount);
      localStorage.setItem('currentResult', JSON.stringify(result));
      
      addToHistory(result);
      
      updateLuck(result);
      
      let isNew = false;
      if (!state.unlockedIds.has(result.id)) {
        state.unlockedIds.add(result.id);
        localStorage.setItem('unlockedChickens', JSON.stringify([...state.unlockedIds]));
        updateCollectionStats();
        dom.collectionBadge.classList.remove('hidden');
        checkFullCollection();
        isNew = true;
      } else {
        updateCollectionStats(); 
      }
      
      checkAchievements();
      
      showResult(result, true, isNew);
    };

    const checkFullCollection = () => {
        if (state.unlockedIds.size === chickenResults.length && !state.hasCelebratedFullCollection) {
            state.hasCelebratedFullCollection = true;
            setTimeout(() => {
                showToast('ğŸ‰ æ­å–œï¼æ‚¨å·²è¾¾æˆå…¨æ”¶é›†æˆå°±ï¼ğŸ‰');
                playSound('complete');
                var end = Date.now() + (5 * 1000);
                (function frame() {
                  confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#FFD700', '#FCD34D'] });
                  confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#FFD700', '#FCD34D'] });
                  if (Date.now() < end) requestAnimationFrame(frame);
                }());
            }, 1000);
        }
    };

    const showResult = (result, playEffects = true, isNew = false) => {
      dom.testArea.classList.add('hidden');
      dom.resultArea.classList.remove('hidden');
      
      dom.resultTitle.textContent = result.name;
      dom.resultDescription.textContent = result.description;
      dom.randomQuote.textContent = "â€œ " + chickenQuotes[Math.floor(Math.random() * chickenQuotes.length)] + " â€";
      
      dom.resultCardInner.className = 'bg-yellow-50 rounded-2xl p-6 flex flex-col items-center justify-center min-h-[20rem] border-4 border-yellow-100 transition-colors duration-500 relative w-full';
      dom.resultTitle.className = 'text-2xl md:text-3xl font-bold text-gray-800 mb-2';
      dom.rareTag.classList.add('hidden');
      dom.newBadgeContainer.innerHTML = '';

      if (isNew) {
         const badge = document.createElement('div');
         badge.className = 'new-badge';
         badge.textContent = 'NEW! æ–°è§£é”';
         dom.newBadgeContainer.appendChild(badge);
      }
      
      if (result.category === 'hidden') {
        dom.resultCardInner.classList.add('rare-bg', 'border-yellow-400');
        dom.resultCardInner.classList.remove('bg-yellow-50', 'border-yellow-100');
        dom.resultTitle.classList.add('text-red-600');
        dom.rareTag.textContent = 'âœ¨ éšè—æ¬¾ âœ¨';
        dom.rareTag.className = 'absolute top-3 right-3 px-3 py-1 bg-gradient-to-r from-yellow-400 to-red-500 text-white text-xs font-bold rounded-full shadow-sm z-10';
        dom.rareTag.classList.remove('hidden');
      } else if (result.category === 'special') {
        dom.resultCardInner.classList.add('special-bg', 'border-purple-400');
        dom.resultCardInner.classList.remove('bg-yellow-50', 'border-yellow-100');
        dom.resultTitle.classList.add('text-purple-600');
        dom.rareTag.textContent = 'ğŸŒŸ ç‰¹æ®Šæ¬¾ ğŸŒŸ';
        dom.rareTag.className = 'absolute top-3 right-3 px-3 py-1 bg-gradient-to-r from-purple-400 to-pink-500 text-white text-xs font-bold rounded-full shadow-sm z-10';
        dom.rareTag.classList.remove('hidden');
      }

      const imagePath = `image/${result.id}.png`;
      dom.resultImage.src = imagePath;
      dom.resultImage.classList.remove('hidden');
      dom.resultEmojiDisplay.classList.add('hidden');
      
      dom.resultImage.onerror = () => {
        dom.resultImage.classList.add('hidden');
        dom.resultEmojiDisplay.textContent = result.emoji;
        dom.resultEmojiDisplay.classList.remove('hidden');
      };

      if (playEffects) {
        playSound('complete');
        const particleCount = result.category ? 150 : 50;
        confetti({
          particleCount: particleCount,
          spread: 70,
          origin: { y: 0.6 },
          colors: result.category === 'hidden' ? ['#FFD700', '#FFA500'] : (result.category === 'special' ? ['#A855F7', '#EC4899'] : undefined)
        });
      }
    };

    const updateCollectionStats = () => {
      let visibleTotal = 0;
      chickenResults.forEach(c => {
        if (c.category !== 'hidden' || state.unlockedIds.has(c.id)) {
          visibleTotal++;
        }
      });
      dom.collectionCount.textContent = state.unlockedIds.size;
      dom.totalCount.textContent = visibleTotal;
      dom.totalDraws.textContent = state.drawCount;
    };

    
    const updateLuckDisplay = () => {
      dom.luckValue.textContent = state.luckValue;
      dom.luckBar.style.width = `${state.luckValue}%`;
    };

    const updateLuck = (result) => {
      let change = 0;
      if (result.category === 'hidden') {
        change = -10;
      } else if (result.category === 'special') {
        change = -5;
      } else {
        change = Math.random() > 0.5 ? 1 : -1;
      }
      
      state.luckValue = Math.max(0, Math.min(CONFIG.MAX_LUCK, state.luckValue + change));
      localStorage.setItem('luckValue', state.luckValue);
      updateLuckDisplay();
      
      if (change > 0) {
        showToast(`ğŸ€ å¹¸è¿å€¼ +${change}`);
      } else if (change < 0) {
        showToast(`ğŸ’¨ å¹¸è¿å€¼ ${change}`);
      }
    };

    
    const checkAchievements = () => {
      let newUnlocked = [];
      ACHIEVEMENTS.forEach(achievement => {
        if (!state.unlockedAchievements.has(achievement.id) && achievement.condition()) {
          state.unlockedAchievements.add(achievement.id);
          newUnlocked.push(achievement);
        }
      });
      
      if (newUnlocked.length > 0) {
        localStorage.setItem('unlockedAchievements', JSON.stringify([...state.unlockedAchievements]));
        dom.achievementBadge.classList.remove('hidden');
        
        setTimeout(() => {
          newUnlocked.forEach((ach, index) => {
            setTimeout(() => {
              showToast(`ğŸ† è§£é”æˆå°±: ${ach.emoji} ${ach.name}`);
              playSound('complete');
            }, index * 2000);
          });
        }, 1000);
      }
    };

    const renderAchievements = () => {
      dom.achievementList.innerHTML = '';
      ACHIEVEMENTS.forEach(achievement => {
        const isUnlocked = state.unlockedAchievements.has(achievement.id);
        const el = document.createElement('div');
        el.className = `p-4 rounded-xl border-2 transition-all ${
          isUnlocked 
            ? 'bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200' 
            : 'bg-gray-50 border-gray-200 opacity-60'
        }`;
        el.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="text-3xl">${isUnlocked ? achievement.emoji : 'ğŸ”’'}</div>
            <div class="flex-1">
              <h3 class="font-bold text-gray-800 ${isUnlocked ? '' : 'text-gray-400'}">${achievement.name}</h3>
              <p class="text-sm text-gray-600 ${isUnlocked ? '' : 'text-gray-400'}">${achievement.desc}</p>
            </div>
            ${isUnlocked ? '<div class="text-green-500 text-xl">âœ”</div>' : ''}
          </div>
        `;
        dom.achievementList.appendChild(el);
      });
      dom.achievementCount.textContent = state.unlockedAchievements.size;
    };

    const toggleAchievement = (show) => {
      if (show) {
        renderAchievements();
        dom.achievementModal.classList.remove('hidden');
        dom.achievementBadge.classList.add('hidden');
        setTimeout(() => {
          dom.achievementContent.classList.remove('opacity-0', 'scale-95');
          dom.achievementContent.classList.add('opacity-100', 'scale-100');
        }, 10);
      } else {
        dom.achievementContent.classList.remove('opacity-100', 'scale-100');
        dom.achievementContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
          dom.achievementModal.classList.add('hidden');
        }, 300);
      }
    };

    
    const addToHistory = (result) => {
      const historyItem = {
        ...result,
        timestamp: Date.now()
      };
      state.history.unshift(historyItem);
      if (state.history.length > CONFIG.HISTORY_MAX_LENGTH) {
        state.history = state.history.slice(0, CONFIG.HISTORY_MAX_LENGTH);
      }
      localStorage.setItem('history', JSON.stringify(state.history));
    };

    const renderHistory = () => {
      dom.historyList.innerHTML = '';
      if (state.history.length === 0) {
        dom.historyList.innerHTML = '<p class="text-gray-400 text-center py-4">è¿˜æ²¡æœ‰å­µåŒ–è®°å½•</p>';
        return;
      }
      state.history.forEach(item => {
        const el = document.createElement('div');
        const date = new Date(item.timestamp);
        const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
        el.className = 'flex items-center gap-2 p-2 bg-white rounded-lg';
        el.innerHTML = `
          <span class="text-2xl">${item.emoji}</span>
          <div class="flex-1">
            <div class="font-bold text-sm">${item.name}</div>
            <div class="text-xs text-gray-400">${timeStr}</div>
          </div>
        `;
        dom.historyList.appendChild(el);
      });
    };

    const renderStats = () => {
      dom.statsTotalDraws.textContent = state.drawCount;
      dom.statsCollection.textContent = `${state.unlockedIds.size}/${chickenResults.length}`;
      dom.statsLuck.textContent = state.luckValue;
      dom.statsAchievements.textContent = state.unlockedAchievements.size;
      
      let normalCount = 0, specialCount = 0, hiddenCount = 0;
      state.history.forEach(item => {
        if (item.category === 'hidden') hiddenCount++;
        else if (item.category === 'special') specialCount++;
        else normalCount++;
      });
      
      dom.statsNormal.textContent = normalCount;
      dom.statsSpecial.textContent = specialCount;
      dom.statsHidden.textContent = hiddenCount;
      
      renderHistory();
    };

    const toggleStats = (show) => {
      if (show) {
        renderStats();
        dom.statsModal.classList.remove('hidden');
        setTimeout(() => {
          dom.statsContent.classList.remove('opacity-0', 'scale-95');
          dom.statsContent.classList.add('opacity-100', 'scale-100');
        }, 10);
      } else {
        dom.statsContent.classList.remove('opacity-100', 'scale-100');
        dom.statsContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
          dom.statsModal.classList.add('hidden');
        }, 300);
      }
    };


    const renderCollection = () => {
      dom.collectionGrid.innerHTML = '';
      dom.collectionDetailPanel.classList.add('hidden');
      
      chickenResults.forEach(chicken => {
        const isUnlocked = state.unlockedIds.has(chicken.id);
        const isHidden = chicken.category === 'hidden';
        if (isHidden && !isUnlocked) return;

        const el = document.createElement('div');
        let classes = 'collection-item';
        if (isUnlocked) {
          if (chicken.category === 'hidden') classes += ' unlocked-hidden';
          else if (chicken.category === 'special') classes += ' unlocked-special';
          else classes += ' unlocked-normal';
        } else {
          classes += ' locked';
        }
        el.className = classes;
        
        if (isUnlocked) {
            el.innerHTML = `<img src="image/${chicken.id}.png" class="w-full h-full object-contain pointer-events-none" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span class="hidden">${chicken.emoji}</span>`;
            el.addEventListener('click', () => showCollectionDetail(chicken));
        } else {
            el.textContent = 'â“';
        }
        dom.collectionGrid.appendChild(el);
      });
    };

    const showCollectionDetail = (chicken) => {
        document.querySelectorAll('.collection-item').forEach(el => el.classList.remove('selected'));
        const imagePath = `image/${chicken.id}.png`;
        dom.detailImg.src = imagePath;
        dom.detailImg.classList.remove('hidden');
        dom.detailEmoji.classList.add('hidden');
        dom.detailImg.onerror = () => {
            dom.detailImg.classList.add('hidden');
            dom.detailEmoji.textContent = chicken.emoji;
            dom.detailEmoji.classList.remove('hidden');
        };

        dom.detailName.textContent = chicken.name;
        dom.detailDesc.textContent = chicken.description;
        
        if (chicken.category === 'hidden') {
            dom.detailTag.textContent = 'éšè—æ¬¾';
            dom.detailTag.className = 'text-xs px-2 py-0.5 rounded-full text-white bg-yellow-500';
            dom.detailTag.classList.remove('hidden');
        } else if (chicken.category === 'special') {
            dom.detailTag.textContent = 'ç‰¹æ®Šæ¬¾';
            dom.detailTag.className = 'text-xs px-2 py-0.5 rounded-full text-white bg-purple-500';
            dom.detailTag.classList.remove('hidden');
        } else {
            dom.detailTag.classList.add('hidden');
        }
        dom.collectionDetailPanel.classList.remove('hidden');
    };

    const toggleCollection = (show) => {
      if (show) {
        renderCollection();
        dom.collectionModal.classList.remove('hidden');
        dom.collectionBadge.classList.add('hidden');
        setTimeout(() => {
            dom.collectionContent.classList.remove('opacity-0', 'scale-95');
            dom.collectionContent.classList.add('opacity-100', 'scale-100');
        }, 10);
      } else {
        dom.collectionContent.classList.remove('opacity-100', 'scale-100');
        dom.collectionContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            dom.collectionModal.classList.add('hidden');
        }, 300);
      }
    };


    const startHatching = (e) => {
      if (e.cancelable) e.preventDefault();
      if (localStorage.getItem('currentResult')) return;
      
      state.pendingResult = generateWeightedResult();
      
      state.isHolding = true;
      state.startTime = Date.now();
      
      if (state.pendingResult.category === 'hidden') {
         dom.eggBody.style.fill = '#FCD34D'; // Goldish
         dom.eggBody.style.stroke = '#B45309';
      } else if (state.pendingResult.category === 'special') {
         dom.eggBody.style.fill = '#E9D5FF'; // Purpleish
         dom.eggBody.style.stroke = '#7E22CE';
      } else {
         dom.eggBody.style.fill = '#FEF3C7'; // Default
         dom.eggBody.style.stroke = '#F59E0B';
      }

      let rayColor = 'transparent';
      if (state.pendingResult.category === 'hidden') rayColor = '#FFD700'; 
      else if (state.pendingResult.category === 'special') rayColor = '#A855F7'; 
      
      if (rayColor !== 'transparent') {
        dom.eggRaysInner.style.setProperty('--ray-color', rayColor);
      }

      dom.pressHint.classList.add('hidden');
      dom.instruction.textContent = "æ­£åœ¨å­µåŒ–ä¸­...åŠ æ²¹ï¼";
      dom.eggSvg.classList.add('animate-egg-shake');
      dom.testArea.querySelector('.progress-container').classList.add('charging');
      
      vibrate(50);

      state.progressInterval = setInterval(() => {
        if (!state.isHolding) return;
        
        const elapsedTime = Date.now() - state.startTime;
        const progress = Math.min(elapsedTime / 2500, 1);
        dom.progressBar.style.width = `${progress * 100}%`;
        
        if (progress > 0.3) {
            dom.cracks[0].style.opacity = 1;
            updateCrackGlow(dom.cracks[0]);
        }
        if (progress > 0.6) {
            dom.cracks[1].style.opacity = 1;
            updateCrackGlow(dom.cracks[1]);
        }
        if (progress > 0.9) {
            dom.cracks[2].style.opacity = 1;
            updateCrackGlow(dom.cracks[2]);
        }
        
        if (state.pendingResult.category && progress > 0.2) {
            dom.eggRays.style.opacity = progress * 0.8;
        }
        
        if (progress > 0.8 && Math.random() > 0.7) vibrate(20);

        if (progress >= 1) {
          stopHatching(true);
          finishHatching(state.pendingResult);
        }
      }, 30);
    };

    const updateCrackGlow = (crackEl) => {
        if (!state.pendingResult) return;
        if (state.pendingResult.category === 'hidden') {
            crackEl.classList.add('crack-glow-gold');
        } else if (state.pendingResult.category === 'special') {
            crackEl.classList.add('crack-glow-purple');
        }
    };

    const stopHatching = (isFinishing = false) => {
      state.isHolding = false;
      clearInterval(state.progressInterval);
      dom.eggSvg.classList.remove('animate-egg-shake');
      dom.testArea.querySelector('.progress-container').classList.remove('charging');
      
      if (!isFinishing) {
          dom.eggRays.style.opacity = 0;
          dom.cracks.forEach(c => {
              c.style.opacity = 0;
              c.classList.remove('crack-glow-gold', 'crack-glow-purple');
          });
          dom.eggBody.style.fill = '#FEF3C7';
          dom.eggBody.style.stroke = '#F59E0B';
      }

      if (!localStorage.getItem('currentResult') && !isFinishing) {
        dom.progressBar.style.width = '0%';
        dom.pressHint.classList.remove('hidden');
        showRandomTip();
        state.pendingResult = null; 
      }
    };

    const resetTest = () => {
      localStorage.removeItem('currentResult');
      dom.resultArea.classList.add('hidden');
      dom.testArea.classList.remove('hidden');
      dom.eggRays.style.opacity = 0;
      dom.cracks.forEach(c => {
          c.style.opacity = 0;
          c.classList.remove('crack-glow-gold', 'crack-glow-purple');
      });
      dom.eggBody.style.fill = '#FEF3C7';
      dom.eggBody.style.stroke = '#F59E0B';
      stopHatching();
    };

    const vibrate = (ms) => {
      if (navigator.vibrate) navigator.vibrate(ms);
    };

    const playSound = (type) => {
      if (state.isMuted) return;
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);

        const now = ctx.currentTime;
        if (type === 'crack') {
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(150, now);
          osc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
          gain.gain.setValueAtTime(0.5, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
          osc.start(now);
          osc.stop(now + 0.1);
        } else if (type === 'complete') {
          osc.type = 'triangle';
          osc.frequency.setValueAtTime(523.25, now); 
          osc.frequency.linearRampToValueAtTime(659.25, now + 0.1); 
          osc.frequency.linearRampToValueAtTime(783.99, now + 0.2); 
          gain.gain.setValueAtTime(0.3, now);
          gain.gain.linearRampToValueAtTime(0, now + 0.5);
          osc.start(now);
          osc.stop(now + 0.5);
        }
      } catch (e) {}
    };

    const generatePoster = () => {
      html2canvas(document.getElementById('capture-target'), {
        backgroundColor: null,
        scale: 2,
        useCORS: true 
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = `æˆ‘æ˜¯${dom.resultTitle.textContent}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showToast('ğŸ“¸ æµ·æŠ¥å·²ç”Ÿæˆï¼Œå¿«å»ç›¸å†Œçœ‹çœ‹ï¼');
      }).catch(err => {
        console.error(err);
        showToast('âŒ ç”Ÿæˆæµ·æŠ¥å¤±è´¥ï¼Œè¯·å°è¯•æˆªå›¾~');
      });
    };

    const copyResult = () => {
      const url = window.location.href;
      const text = `æˆ‘åœ¨ã€Šæµ‹æµ‹ä½ æ˜¯ä»€ä¹ˆé¸¡ã€‹ä¸­å­µåŒ–å‡ºäº†ã€${dom.resultTitle.textContent}ã€‘ï¼\n${dom.resultDescription.textContent}\nä½ ä¹Ÿæ¥è¯•è¯•å§ï¼ğŸ‘‰ ${url}`;
      const onSuccess = () => showToast('ğŸ”— ç»“æœå·²å¤åˆ¶ï¼Œå¿«å»åˆ†äº«å§ï¼');
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(onSuccess);
      } else {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        onSuccess();
      }
    };

    const pc = document.querySelector('.progress-container');
    pc.addEventListener('mousedown', startHatching);
    pc.addEventListener('touchstart', startHatching, { passive: false });
    document.addEventListener('mouseup', () => stopHatching(false));
    document.addEventListener('touchend', () => stopHatching(false));
    document.addEventListener('touchcancel', () => stopHatching(false));

    document.getElementById('retest-button').addEventListener('click', resetTest);
    dom.btnShare.addEventListener('click', generatePoster);
    dom.btnCopy.addEventListener('click', copyResult);
    dom.btnMute.addEventListener('click', () => {
      state.isMuted = !state.isMuted;
      dom.btnMute.textContent = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      localStorage.setItem('isMuted', state.isMuted);
    });
    dom.btnCollection.addEventListener('click', () => toggleCollection(true));
    dom.btnCloseCollection.addEventListener('click', () => toggleCollection(false));
    dom.collectionModal.addEventListener('click', (e) => {
        if(e.target === dom.collectionModal) toggleCollection(false);
    });
    dom.btnAchievement.addEventListener('click', () => toggleAchievement(true));
    dom.btnCloseAchievement.addEventListener('click', () => toggleAchievement(false));
    dom.achievementModal.addEventListener('click', (e) => {
        if(e.target === dom.achievementModal) toggleAchievement(false);
    });
    dom.btnStats.addEventListener('click', () => toggleStats(true));
    dom.btnCloseStats.addEventListener('click', () => toggleStats(false));
    dom.statsModal.addEventListener('click', (e) => {
        if(e.target === dom.statsModal) toggleStats(false);
    });
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());

    init();
  </script>
</body>
</html>